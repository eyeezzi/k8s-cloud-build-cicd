steps:

# download dependencies
# SKIP

# run tests
- name: 'gcr.io/cloud-builders/go:alpine'
  id: Run unit tests
  args: ['test', './src/']
  env: ['GOPATH=.']
  # env: ['PROJECT_ROOT=polite']

# bundle app into container image
- name: 'gcr.io/cloud-builders/docker'
  id: Build docker image
  args: [ 'build', '--quiet', '-t', 'gcr.io/$PROJECT_ID/polite:$SHORT_SHA', '.']

# push the image to a registry
- name: 'gcr.io/cloud-builders/docker'
  id: Push image to registry
  args: [ 'push', 'gcr.io/$PROJECT_ID/polite:$SHORT_SHA']

# update image in staging deployment manifest
- name: 'gcr.io/cloud-builders/gcloud'
  id: Update deployment image tag for staging
  entrypoint: /bin/sh
  args:
  - '-c'
  - |
    sed -E -i "" "s|image:[[:space:]]*gcr[^[:space:]]*|image:\ gcr.io/$PROJECT_ID/polite:$SHORT_SHA|g" k8s/staging-deployment.yaml && \
    cat k8s/staging-deployment.yaml
images:
- 'gcr.io/$PROJECT_ID/polite'